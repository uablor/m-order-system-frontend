# คู่มือการใช้งานหน้าสร้างออเดอร์ (Stock / Order)

## ภาพรวม

หน้านี้ใช้สำหรับ **สร้างออเดอร์ใหม่** โดยเชื่อมต่อกับ API `POST /orders/create-full` ซึ่งจะสร้าง:
- ออเดอร์หลัก (Order Header)
- รายการสินค้า (Order Items)
- ออเดอร์ของลูกค้า (Customer Orders) พร้อมจัดสรรสินค้าให้ลูกค้าแต่ละคน

ทั้งหมดนี้ทำได้ในครั้งเดียว (Single Transaction)

---

## ขั้นตอนการใช้งาน

### ขั้นตอนที่ 1: ตรวจสอบอัตราแลกเปลี่ยน

เมื่อเข้าหน้านี้ ระบบจะ:
1. ตรวจสอบว่ามีอัตราแลกเปลี่ยน **BUY** และ **SELL** สำหรับวันนี้หรือไม่
2. ถ้ายังไม่มี จะแสดง **Modal** ให้กรอกอัตราแลกเปลี่ยนก่อน
3. ถ้ามีครบแล้ว จะแสดงข้อมูลอัตราแลกเปลี่ยนด้านบนของหน้า เช่น:
   - **BUY:** 1 CNY = 3,500 LAK
   - **SELL:** 1 CNY = 4,000 LAK

> **สำคัญ:** ต้องตั้งค่าอัตราแลกเปลี่ยนก่อนถึงจะสร้างออเดอร์ได้ เพราะ Backend ใช้อัตรานี้ในการคำนวณต้นทุน กำไร ทั้งหมด

---

### ขั้นตอนที่ 2: กรอกรหัสออเดอร์ (Order Code)

- กรอกรหัสออเดอร์ในช่อง **"รหัสออเดอร์"**
- ตัวอย่าง: `ORD-2025-001`, `STOCK-FEB-01`
- รหัสนี้จะถูกบันทึกไปกับออเดอร์ สามารถใช้ค้นหาออเดอร์ได้ภายหลัง

---

### ขั้นตอนที่ 3: เพิ่มรายการสินค้า (Order Items)

กดปุ่ม **"+ เพิ่มรายการ"** เพื่อเพิ่มสินค้าแต่ละตัว แต่ละรายการจะมีฟิลด์:

| ฟิลด์ | คำอธิบาย | ตัวอย่าง |
|---|---|---|
| **ชื่อสินค้า** | ชื่อสินค้าที่สั่งซื้อ (จำเป็น) | เสื้อยืดโมเดิร์น |
| **ตัวเลือก** | สี ไซส์ หรือรายละเอียดเพิ่มเติม | ไซส์ L / สีแดง |
| **จำนวน** | จำนวนชิ้นที่สั่งซื้อ (ขั้นต่ำ 1) | 10 |
| **ราคาซื้อ** | ราคาต้นทุนต่อชิ้น (สกุลเงินต้นทาง เช่น CNY) | 50.00 |
| **ค่าส่ง** | ค่าขนส่งต่อรายการ (สกุลเงินต้นทาง) | 5.00 |
| **ราคาขาย** | ราคาขายต่อชิ้น (สกุลเงินขาย เช่น CNY) | 80.00 |
| **ประเภทส่วนลด** | เลือก % (เปอร์เซ็นต์) หรือ เงินสด | % |
| **มูลค่าส่วนลด** | จำนวนส่วนลด (แสดงเมื่อเลือกประเภทส่วนลด) | 10 |

#### สิ่งที่ Backend คำนวณให้อัตโนมัติ:
- **ต้นทุนรวม (LAK)** = ราคาซื้อ x จำนวน x อัตรา BUY
- **ค่าส่ง (LAK)** = ค่าส่ง x อัตรา BUY
- **ส่วนลด (LAK)** = คำนวณจากประเภทส่วนลด
- **ต้นทุนสุทธิ (LAK)** = ต้นทุนรวม + ค่าส่ง - ส่วนลด
- **ยอดขาย (LAK)** = ราคาขาย x จำนวน x อัตรา SELL
- **กำไร (LAK)** = ยอดขาย - ต้นทุนสุทธิ

> สามารถเพิ่มหลายรายการได้ กดปุ่ม **"+ เพิ่มรายการ"** ซ้ำ และลบรายการที่ไม่ต้องการด้วยปุ่มถังขยะ

---

### ขั้นตอนที่ 4: จัดสรรสินค้าให้ลูกค้า (Customer Orders)

กดปุ่ม **"+ เพิ่มลูกค้า"** เพื่อเพิ่มออเดอร์ของลูกค้าแต่ละคน

#### 4.1 เลือกลูกค้า

- ใช้ช่อง **"เลือกลูกค้า"** แบบ Dropdown Search
- **สามารถพิมพ์ค้นหา** ชื่อลูกค้าหรือเบอร์โทรได้เลย
- ระบบจะโหลดรายชื่อลูกค้าจาก API โดยอัตโนมัติ
- แต่ละรายการจะแสดง **ชื่อลูกค้า** + **ป้ายประเภท** (CUSTOMER / AGENT)

> ถ้ายังไม่มีลูกค้าในระบบ ต้องไปสร้างลูกค้าในเมนู **"Customer Management"** ก่อน

#### 4.2 จัดสรรสินค้า

หลังเลือกลูกค้าแล้ว กดปุ่ม **"+ เพิ่มรายการ"** ในส่วนของลูกค้า เพื่อจัดสรรสินค้าให้ลูกค้าคนนั้น:

| ฟิลด์ | คำอธิบาย |
|---|---|
| **เลือกสินค้า** | เลือกจากรายการสินค้าที่เพิ่มไว้ในขั้นตอนที่ 3 (แสดง #ลำดับ + ชื่อสินค้า) |
| **จำนวน** | จำนวนชิ้นที่จัดสรรให้ลูกค้าคนนี้ (ต้องไม่เกินจำนวนที่สั่งซื้อ) |
| **ราคาพิเศษ** | (ไม่จำเป็น) กรอกเฉพาะเมื่อต้องการขายในราคาพิเศษที่ต่างจากราคาขายหลัก |

**ตัวอย่าง:**
- สินค้า #1 "เสื้อยืด" สั่ง 10 ตัว
- ลูกค้า A: 3 ตัว (ราคาปกติ)
- ลูกค้า B: 5 ตัว (ราคาพิเศษ 70 CNY)
- เหลืออีก 2 ตัว (stock สำรอง)

> **หมายเหตุ:** ระบบจะตรวจสอบว่าจำนวนที่จัดสรรให้ลูกค้าทุกคนรวมกัน ต้องไม่เกินจำนวนที่สั่งซื้อ ถ้าเกินจะแสดง error

---

### ขั้นตอนที่ 5: สร้างออเดอร์

- กดปุ่ม **"สร้างออเดอร์"** ด้านล่าง
- ปุ่มจะกดได้เมื่อ:
  - กรอกรหัสออเดอร์แล้ว
  - มีอย่างน้อย 1 รายการสินค้า
  - ทุกรายการสินค้ามีชื่อและจำนวนถูกต้อง
- เมื่อสร้างสำเร็จ จะแสดง Toast "สร้างออเดอร์สำเร็จ!" และ reset ฟอร์มให้สร้างใหม่ได้ทันที

---

## โครงสร้าง API ที่ใช้

### POST /orders/create-full

```json
{
  "orderCode": "ORD-2025-001",
  "items": [
    {
      "Index": 0,
      "productName": "เสื้อยืด Modern",
      "variant": "ไซส์ L",
      "quantity": 10,
      "purchasePrice": 50,
      "shippingPrice": 5,
      "discountType": "percent",
      "discountValue": 10,
      "sellingPriceForeign": 80
    }
  ],
  "customerOrders": [
    {
      "customerId": 1,
      "items": [
        {
          "orderItemIndex": 0,
          "quantity": 3,
          "sellingPriceForeign": 80
        }
      ]
    }
  ]
}
```

### Response

```json
{
  "success": true,
  "order": { ... },
  "message": "Order created successfully"
}
```

---

## การรองรับ Responsive

| ขนาดจอ | พฤติกรรม |
|---|---|
| **Desktop** (>768px) | แสดงฟิลด์เรียงกันเป็นแถว 2 แถว: แถว 1 ข้อมูลสินค้า, แถว 2 ข้อมูลราคา |
| **Tablet** (768px) | ฟิลด์ปรับขนาดให้พอดี แบ่งเป็น 2-3 คอลัมน์ |
| **Mobile** (<768px) | ฟิลด์แสดงเป็น 1-2 คอลัมน์ ปุ่มสร้างออเดอร์ขยายเต็มจอ |

---

## ภาษาที่รองรับ

- **English** (en)
- **ไทย** (th)
- **ລາວ** (la)

เปลี่ยนภาษาได้จากเมนูภาษาบนหัวเว็บไซต์

---

## ไฟล์ที่เกี่ยวข้อง

| ไฟล์ | หน้าที่ |
|---|---|
| `StockOrderContent.vue` | Component หลักของหน้าสร้างออเดอร์ |
| `StockOrderPage.vue` | Page wrapper + ตรวจสอบ exchange rate วันนี้ |
| `ExchangeRateBulkModal.vue` | Modal สำหรับกรอกอัตราแลกเปลี่ยน (BUY/SELL) |
| `order.repository.ts` | Repository เรียก API สร้างออเดอร์ |
| `customer.repository.ts` | Repository เรียก API รายชื่อลูกค้า |
| `exchange-rate.repository.ts` | Repository เรียก API อัตราแลกเปลี่ยน |
| `api-endpoints.ts` | กำหนด endpoint URL ทั้งหมด |
| `en/merchant/merchant.json` | ข้อความภาษาอังกฤษ |
| `th/merchant/merchant.json` | ข้อความภาษาไทย |
| `la/merchant/merchant.json` | ข้อความภาษาลาว |

---

## Flow Diagram

```
เข้าหน้า Stock / Order
         │
         ▼
 ตรวจสอบ Exchange Rate วันนี้
         │
    ┌────┴────┐
    │         │
  มีครบ   ไม่ครบ
    │         │
    │     เปิด Modal
    │     กรอกอัตรา
    │         │
    └────┬────┘
         │
         ▼
  แสดงฟอร์มสร้างออเดอร์
         │
         ▼
  กรอก Order Code
         │
         ▼
  เพิ่มรายการสินค้า (Items)
  - ชื่อ, ตัวเลือก, จำนวน
  - ราคาซื้อ, ค่าส่ง, ราคาขาย
  - ส่วนลด (ถ้ามี)
         │
         ▼
  เพิ่มลูกค้า (Customer Orders)
  - ค้นหาและเลือกลูกค้า
  - จัดสรรสินค้า + จำนวน
  - ราคาพิเศษ (ถ้ามี)
         │
         ▼
  กด "สร้างออเดอร์"
         │
         ▼
  POST /orders/create-full
         │
    ┌────┴────┐
    │         │
  สำเร็จ    Error
    │         │
  Toast    แสดงข้อผิดพลาด
  Reset    ให้แก้ไขข้อมูล
  ฟอร์ม
```
